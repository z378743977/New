<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¤šè¯­è¨€è¡¨å•å¡«å†™åº”ç”¨ï¼ˆç§»åŠ¨ç«¯ä¸‹è½½å…¼å®¹ç‰ˆï¼‰</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { min-height:100vh; position:relative; }
    body {
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI','Microsoft YaHei',sans-serif;
      background: linear-gradient(135deg, #F5F5F0 0%, #D4E4E7 50%, #B8D4D6 100%);
      min-height:100vh; padding:20px; position:relative; overflow-x:hidden;
    }
    body::before {
      content:''; position:fixed; top:-50%; right:-50%; width:200%; height:200%;
      background: radial-gradient(circle, rgba(74,144,164,.05) 0%, transparent 70%);
      animation: rotate 30s linear infinite; pointer-events:none; z-index:0;
    }
    @keyframes rotate { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    #app { position:relative; z-index:1; }
    .container {
      max-width:500px; margin:0 auto; background:#FAFAF8; border-radius:12px;
      box-shadow:0 10px 40px rgba(46,79,122,.15); padding:30px;
      border:1px solid rgba(62,95,138,.1);
    }
    .admin-container { max-width:1400px; }
    h1 { text-align:center; color:#2E4F7A; font-size:24px; margin-bottom:30px; font-weight:bold; }
    .admin-title { color:#1E3A5F; font-size:28px; }
    label { display:block; font-weight:600; font-size:14px; margin-bottom:8px; color:#2C3E50; transition:all .3s; }
    .form-group:hover label { color:#3E5F8A; transform:translateX(3px); }
    input[type='text'], input[type='date'], input[type='number'], select {
      width:100%; padding:10px 15px; border:2px solid #D4E4E7; border-radius:8px; font-size:14px; transition:all .3s; background:#fff;
    }
    input:focus, select:focus {
      outline:none; border-color:#3E5F8A; box-shadow:0 0 0 3px rgba(62,95,138,.1); transform:translateY(-2px); background:#FEFEFE;
    }
    .form-group{ margin-bottom:20px; }
    .language-buttons{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:30px; }
    .lang-btn, .tab-btn, .field-btn, .toggle-btn, .action-btn {
      padding:10px; border:none; border-radius:8px; background:#E8F0F2; color:#2C3E50; font-weight:500; cursor:pointer;
      transition:all .3s; border:1px solid rgba(62,95,138,.2);
    }
    .lang-btn:hover, .tab-btn:hover, .field-btn:hover, .toggle-btn:hover, .action-btn:hover { background:#D4E4E7; transform:translateY(-2px); box-shadow:0 4px 12px rgba(62,95,138,.15); }
    .lang-btn.active, .tab-btn.active { background:#3E5F8A; color:#fff; }
    .signature-container{ border:2px solid #B8D4D6; border-radius:8px; overflow:hidden; margin-top:10px; transition:all .3s; }
    .signature-container:hover{ border-color:#4A90A4; box-shadow:0 4px 16px rgba(74,144,164,.2); transform:scale(1.01); }
    canvas{ display:block; width:100%; background:#fff; cursor:crosshair; touch-action:none; }
    .clear-btn{ margin-top:10px; background:none; border:none; color:#C73E1D; font-size:14px; cursor:pointer; text-decoration:underline; }
    .clear-btn:hover{ color:#A32E15; }
    .generate-btn{
      width:100%; padding:15px; background:linear-gradient(135deg,#3E5F8A 0%, #2E4F7A 100%); color:#fff; border:none; border-radius:8px;
      font-size:16px; font-weight:600; cursor:pointer; margin-top:30px; transition:all .3s; display:flex; align-items:center; justify-content:center; gap:10px;
      box-shadow:0 4px 12px rgba(62,95,138,.2);
    }
    .generate-btn:hover{ background:linear-gradient(135deg,#2E4F7A 0%,#1E3A5F 100%); transform:translateY(-2px); box-shadow:0 6px 16px rgba(62,95,138,.3); }
    .note{ text-align:center; font-size:12px; color:#5A7A8F; margin-top:20px; }
    .admin-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; }
    .admin-layout{ display:grid; grid-template-columns:2fr 1fr; gap:30px; }
    .left-panel,.right-panel{
      background:#FAFAF8; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(62,95,138,.1); border:1px solid rgba(62,95,138,.1);
    }
    .section-title{ font-size:18px; font-weight:700; color:#2E4F7A; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #B8D4D6; }
    .template-tabs,.language-tabs{ display:flex; gap:10px; margin-bottom:20px; }
    .field-buttons{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:20px; }
    .preview-box{ border:2px solid #A8DADC; background:#F0F8F9; padding:15px; border-radius:8px; margin-bottom:20px; }
    .image-wrapper{ position:relative; display:inline-block; max-width:100%; }
    .preview-box img{ max-width:100%; cursor:crosshair; border:2px dashed #A8DADC; display:block; }
    #markersContainer{ position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
    .field-marker{
      position:absolute; width:28px; height:28px; background:rgba(74,144,164,.9); color:#fff; border-radius:50%;
      display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; transform:translate(-50%,-150%);
      box-shadow:0 2px 8px rgba(62,95,138,.3); border:3px solid #fff; z-index:10;
    }
    .field-label{ position:absolute; background:rgba(74,144,164,.95); color:#fff; padding:4px 10px; border-radius:4px; font-size:11px; font-weight:600; transform:translate(-50%,-250%); white-space:nowrap; z-index:10; }
    .field-preview-text{ position:absolute; pointer-events:none; z-index:8; white-space:nowrap; opacity:.9; }
    .field-list{ margin-top:20px; }
    .field-item{ background:#F5F8F9; border:1px solid #D4E4E7; border-radius:8px; padding:12px; margin-bottom:10px; }
    .field-item-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .field-name{ font-weight:600; color:#2E4F7A; }
    .field-actions{ display:flex; gap:8px; }
    .edit-btn{ padding:4px 12px; border:none; border-radius:4px; cursor:pointer; font-size:12px; background:#3E5F8A; color:#fff; }
    .delete-btn{ padding:4px 12px; border:none; border-radius:4px; cursor:pointer; font-size:12px; background:#C73E1D; color:#fff; }
    .reposition-btn{ padding:4px 12px; border:none; border-radius:4px; cursor:pointer; font-size:12px; background:#F7B500; color:#fff; }
    .param-editor{ background:#fff; border:2px solid #3E5F8A; border-radius:8px; padding:15px; margin-top:10px; }
    .param-row{ display:grid; grid-template-columns:100px 1fr; gap:10px; margin-bottom:12px; align-items:center; }
    .param-label{ font-size:13px; font-weight:600; color:#2C3E50; }
    .save-param-btn{ width:100%; padding:8px; background:#4A90A4; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
    .upload-section{ margin-bottom:20px; padding:15px; background:#F5F8F9; border-radius:8px; border:1px solid #D4E4E7; }
    .mode-switch{ margin-top:15px; padding:12px; background:#F0F8F9; border:2px solid #A8DADC; border-radius:8px; display:flex; align-items:center; gap:10px; }
    .password-container{ max-width:400px; text-align:center; }
    .password-title{ font-size:24px; font-weight:700; color:#2E4F7A; margin-bottom:10px; }
    .password-subtitle{ color:#5A7A8F; margin-bottom:20px; font-size:14px; }
    .password-input{ width:100%; padding:15px; border:2px solid #D4E4E7; border-radius:8px; font-size:16px; margin-bottom:12px; text-align:center; letter-spacing:2px; background:#fff; }
    .password-btn{ width:100%; padding:15px; background:linear-gradient(135deg,#3E5F8A 0%, #2E4F7A 100%); color:#fff; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; }
    .password-error{ color:#C73E1D; font-size:14px; margin-top:10px; display:none; }
    .password-error.show{ display:block; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ===================== å¤šè¯­è¨€ä¸å·¥ç§ =====================
    const translations = {
      zh:{ title:'å‘˜å·¥ä¿¡æ¯è¡¨å•', selectLanguage:'é€‰æ‹©è¯­è¨€', name:'å§“å', birthday:'ç”Ÿæ—¥', address:'åœ°å€', addressSearch:'æœç´¢åœ°å€', position:'èŒä½', positionCustom:'è‡ªå¡«', positionSelect:'é€‰æ‹©å·¥ç§', passport:'æŠ¤ç…§å·', phone:'æ‰‹æœºå·', experience:'å·¥ä½œç»å†', experienceYears:'å¹´', signature:'ç­¾å', clearSignature:'æ¸…é™¤ç­¾å', generate:'ç”Ÿæˆè¡¨å•', adminMode:'ç®¡ç†å‘˜æ¨¡å¼', userMode:'ç”¨æˆ·æ¨¡å¼', generateNote:'ç‚¹å‡»ç”Ÿæˆåå°†ä¸‹è½½2å¼ å¡«å¥½çš„è¡¨å•å›¾ç‰‡(è‡ªåŠ¨æ·»åŠ å½“å‰æ—¥æœŸ)', addressHint:'ğŸ’¡ åœ¨Naveråœ°å›¾ä¸­æœç´¢åœ°å€,ç„¶åå¤åˆ¶ç²˜è´´åˆ°è¾“å…¥æ¡†' },
      ko:{ title:'ì§ì› ì •ë³´ ì–‘ì‹', selectLanguage:'ì–¸ì–´ ì„ íƒ', name:'ì„±ëª…', birthday:'ìƒë…„ì›”ì¼', address:'ì£¼ì†Œ', addressSearch:'ì£¼ì†Œ ê²€ìƒ‰', position:'ì§ì¢…', positionCustom:'ì§ì ‘ ì…ë ¥', positionSelect:'ì„ íƒ', residentNum:'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸', phone:'ì „í™”ë²ˆí˜¸', experience:'ê²½ë ¥', experienceYears:'ë…„', signature:'ì„œëª…', clearSignature:'ì„œëª… ì§€ìš°ê¸°', generate:'ì–‘ì‹ ìƒì„±', adminMode:'ê´€ë¦¬ì ëª¨ë“œ', userMode:'ì‚¬ìš©ì ëª¨ë“œ', generateNote:'ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì‘ì„±ëœ ì–‘ì‹ 2ì¥ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤(í˜„ì¬ ë‚ ì§œ ìë™ ì¶”ê°€)', addressHint:'ğŸ’¡ Naver ì§€ë„ì—ì„œ ì£¼ì†Œë¥¼ ê²€ìƒ‰í•œ í›„ ì…ë ¥ë€ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”' },
      vi:{ title:'Máº«u thÃ´ng tin nhÃ¢n viÃªn', selectLanguage:'Chá»n ngÃ´n ngá»¯', name:'Há» vÃ  tÃªn', birthday:'NgÃ y sinh', address:'Äá»‹a chá»‰', addressSearch:'TÃ¬m Ä‘á»‹a chá»‰', position:'Vá»‹ trÃ­', positionCustom:'Tá»± nháº­p', positionSelect:'Chá»n', passport:'Sá»‘ há»™ chiáº¿u', phone:'Sá»‘ Ä‘iá»‡n thoáº¡i', experience:'Kinh nghiá»‡m', experienceYears:'nÄƒm', signature:'Chá»¯ kÃ½', clearSignature:'XÃ³a chá»¯ kÃ½', generate:'Táº¡o máº«u', adminMode:'Cháº¿ Ä‘á»™ quáº£n trá»‹', userMode:'Cháº¿ Ä‘á»™ ngÆ°á»i dÃ¹ng', generateNote:'Nháº¥p táº¡o Ä‘á»ƒ táº£i xuá»‘ng 2 máº«u Ä‘Ã£ Ä‘iá»n (tá»± Ä‘á»™ng thÃªm ngÃ y hiá»‡n táº¡i)', addressHint:'ğŸ’¡ TÃ¬m kiáº¿m Ä‘á»‹a chá»‰ trÃªn báº£n Ä‘á»“ Naver, sau Ä‘Ã³ sao chÃ©p vÃ  dÃ¡n vÃ o Ã´ nháº­p' },
      ru:{ title:'Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞµ', selectLanguage:'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº', name:'Ğ¤Ğ˜Ğ', birthday:'Ğ”Ğ°Ñ‚Ğ° Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ', address:'ĞĞ´Ñ€ĞµÑ', addressSearch:'ĞŸĞ¾Ğ¸ÑĞº Ğ°Ğ´Ñ€ĞµÑĞ°', position:'Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ', positionCustom:'Ğ’Ğ²ĞµÑÑ‚Ğ¸', positionSelect:'Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ', passport:'ĞĞ¾Ğ¼ĞµÑ€ Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ°', phone:'Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½', experience:'ĞĞ¿Ñ‹Ñ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹', experienceYears:'Ğ»ĞµÑ‚', signature:'ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑŒ', clearSignature:'ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒ', generate:'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ñƒ', adminMode:'Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°', userMode:'Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ', generateNote:'ĞŸĞ¾ÑĞ»Ğµ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ 2 Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ (Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ´Ğ°Ñ‚Ñ‹)', addressHint:'ğŸ’¡ ĞĞ°Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ°Ğ´Ñ€ĞµÑ Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ğµ Naver, Ğ·Ğ°Ñ‚ĞµĞ¼ ÑĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¸ Ğ²ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ² Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ°' }
    };

    const positionOptions = {
      zh:['æ•´ç†','è€ç‚®','æ‹†é™¤','é’¢ç­‹','æµ‡ç­‘','æ¶å­å·¥','ä¿¡å·å‘˜','äºŒç‚®','é’¢ç‚®','ç¢çŸ³æŠ¹ç°','å®‰å…¨'],
      ko:['ì •ë¦¬','í˜•í‹€','í•´ì²´','ì² ê·¼','íƒ€ì„¤','ë¹„ê³„','ì‹ í˜¸ìˆ˜','ì•Œí¼','ê°±í¼','í• ì„ë¯¸ì¥','ì•ˆì „'],
      vi:['ì •ë¦¬','í˜•í‹€','í•´ì²´','ì² ê·¼','íƒ€ì„¤','ë¹„ê³„','ì‹ í˜¸ìˆ˜','ì•Œí¼','ê°±í¼','í• ì„ë¯¸ì¥','ì•ˆì „'],
      ru:['ì •ë¦¬','í˜•í‹€','í•´ì²´','ì² ê·¼','íƒ€ì„¤','ë¹„ê³„','ì‹ í˜¸ìˆ˜','ì•Œí¼','ê°±í¼','í• ì„ë¯¸ì¥','ì•ˆì „']
    };

    const positionMapping = {
      'æ•´ç†':'ì •ë¦¬','è€ç‚®':'í˜•í‹€','æ‹†é™¤':'í•´ì²´','é’¢ç­‹':'ì² ê·¼','æµ‡ç­‘':'íƒ€ì„¤','æ¶å­å·¥':'ë¹„ê³„','ä¿¡å·å‘˜':'ì‹ í˜¸ìˆ˜','äºŒç‚®':'ì•Œí¼','é’¢ç‚®':'ê°±í¼','ç¢çŸ³æŠ¹ç°':'í• ì„ë¯¸ì¥','å®‰å…¨':'ì•ˆì „'
    };
    function convertPositionToKorean(p){ return positionMapping[p] || p; }

    // ===================== åº”ç”¨çŠ¶æ€ =====================
    let state = {
      language:'zh',
      formData:{},
      signature:null,
      isDrawing:false,
      isAdminMode:false,
      showPasswordPage:false,
      templates:{ contract:{ zh:null, ko:null }, safety:{ zh:null, ko:null } },
      fieldPositions:{ contract:{ zh:{}, ko:{} }, safety:{ zh:{}, ko:{} } },
      currentTemplate:'contract',
      currentLang:'zh',
      selectedField:null,
      editingField:null,
      multiInstanceMode:false,
      repositionTarget:null,
      positionMode:'custom'
    };

    // ===================== æœ¬åœ°å­˜å‚¨/é»˜è®¤é…ç½® =====================
    function loadFromLocalStorage(){
      try{
        const saved = localStorage.getItem('formFillerConfig');
        if(saved){
          const config = JSON.parse(saved);
          if(config.templates) state.templates = config.templates;
          if(config.fieldPositions) state.fieldPositions = config.fieldPositions;
          return true;
        }
      }catch(e){ console.error('åŠ è½½é…ç½®å¤±è´¥:', e); }
      return false;
    }

    async function loadDefaultConfig(){
      try{
        const res = await fetch('form-config.json');
        if(res.ok){
          const config = await res.json();
          if(config.templates) state.templates = config.templates;
          if(config.fieldPositions) state.fieldPositions = config.fieldPositions;
          return true;
        }
      }catch(e){ /* ignore */ }
      return false;
    }

    function saveToLocalStorage(){
      try{
        const config = { templates: state.templates, fieldPositions: state.fieldPositions };
        localStorage.setItem('formFillerConfig', JSON.stringify(config));
      }catch(e){ console.error('ä¿å­˜é…ç½®å¤±è´¥:', e); }
    }

    async function initConfig(){
      const hasLocal = loadFromLocalStorage();
      if(!hasLocal){ await loadDefaultConfig(); }
      render();
    }

    // ===================== å·¥å…·å‡½æ•° =====================
    function getFieldsList(lang){
      if(lang==='ko'){ return ['name','birthday','address','residentNum','phone','position','experience','month','day','checkmark','signature']; }
      return ['name','birthday','address','position','passport','phone','experience','month','day','checkmark','signature'];
    }
    function getCurrentMonth(){ return String(new Date().getMonth()+1); }
    function getCurrentDay(){ return String(new Date().getDate()); }

    // ğŸ‘‰ ç§»åŠ¨ç«¯å…¼å®¹ä¸‹è½½ï¼ˆæ ¸å¿ƒä¿®å¤ç‚¹ï¼‰
    function safeDownloadFromBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      if(isMobile){
        // ç§»åŠ¨ç«¯æ‰“å¼€æ–°æ ‡ç­¾é¡µï¼Œç”¨æˆ·é•¿æŒ‰ä¿å­˜
        window.open(url, '_blank');
        // å¯é€‰æç¤º
        setTimeout(()=>{ try{ alert('ğŸ“± å·²åœ¨æ–°æ ‡ç­¾æ‰“å¼€å›¾ç‰‡ï¼Œè¯·é•¿æŒ‰ä¿å­˜'); }catch(e){} }, 150);
      }else{
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    // ===================== ç­¾åæ¿ =====================
    let signatureCanvas=null, sigCtx=null;
    function startDrawing(e){
      const rect = signatureCanvas.getBoundingClientRect();
      const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
      const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
      sigCtx.beginPath(); sigCtx.moveTo(x,y); state.isDrawing=true;
    }
    function draw(e){
      if(!state.isDrawing) return;
      e.preventDefault();
      const rect = signatureCanvas.getBoundingClientRect();
      const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
      const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
      sigCtx.lineTo(x,y); sigCtx.stroke();
    }
    function stopDrawing(){
      if(state.isDrawing){ state.isDrawing=false; state.signature = signatureCanvas.toDataURL(); }
    }
    function clearSignature(){ sigCtx.clearRect(0,0,signatureCanvas.width, signatureCanvas.height); state.signature=null; }

    // ===================== ç”Ÿæˆè¡¨å• =====================
    async function generateForms(){
      if(!state.signature){
        const messages = { zh:'è¯·å…ˆç­¾å', ko:'ì„œëª…ì„ í•´ì£¼ì„¸ìš”', vi:'Vui lÃ²ng kÃ½ tÃªn', ru:'ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ' };
        alert(messages[state.language] || 'è¯·å…ˆç­¾å');
        return;
      }
      const langKey = state.language === 'ko' ? 'ko' : 'zh';
      for(const templateType of ['contract','safety']){ await generateForm(templateType, langKey); }
    }

    async function generateForm(templateType, langKey){
      const template = state.templates[templateType][langKey];
      const positions = state.fieldPositions[templateType][langKey];
      if(!template || !positions || Object.keys(positions).length===0){ return; }

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const img = new Image();

      await new Promise((resolve)=>{
        img.onload = ()=>{
          canvas.width = img.width; canvas.height = img.height;
          ctx.drawImage(img,0,0); ctx.textBaseline='top';

          // å†™å…¥æ–‡æœ¬
          Object.keys(positions).forEach(key=>{
            const pos = positions[key]; if(!pos) return;
            const baseField = pos.baseField || key;
            let textValue = '';
            if(baseField==='month'){ textValue=getCurrentMonth(); }
            else if(baseField==='day'){ textValue=getCurrentDay(); }
            else if(baseField==='checkmark'){ textValue='âœ“'; }
            else if(state.formData[baseField]){
              textValue = state.formData[baseField];
              if(baseField==='experience' && textValue){ textValue = textValue + (langKey==='ko'?'ë…„':'å¹´'); }
              else if(baseField==='position' && textValue){ textValue = convertPositionToKorean(textValue); }
            }
            if(textValue){
              ctx.font = `${pos.fontSize || 44}px Arial`;
              ctx.fillStyle = pos.color || '#000';
              ctx.fillText(textValue, pos.x, pos.y);
            }
          });

          // è´´ç­¾å
          Object.keys(positions).forEach(key=>{
            const pos = positions[key]; if(!pos) return;
            const baseField = pos.baseField || key;
            if(baseField==='signature' && state.signature){
              const sigImg = new Image();
              sigImg.onload = ()=>{
                const w = pos.width || 150, h = pos.height || 50;
                ctx.drawImage(sigImg, pos.x, pos.y, w, h);
              };
              sigImg.src = state.signature;
            }
          });

          // å¯¼å‡ºï¼ˆç§»åŠ¨ç«¯å…¼å®¹ï¼‰
          setTimeout(()=>{
            canvas.toBlob(blob=>{
              const filename = `${templateType==='contract'?'åŠ³åŠ¨åˆåŒ':'å®‰å…¨åè®®'}_${langKey}.png`;
              safeDownloadFromBlob(blob, filename);
              resolve();
            });
          }, 120);
        };
        img.src = template;
      });
    }

    // ===================== ä¸Šä¼ /å®šä½ =====================
    function handleTemplateUpload(e, templateType, langKey){
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = (ev)=>{
          state.templates[templateType][langKey] = ev.target.result;
          saveToLocalStorage(); render(); setTimeout(renderFieldMarkers, 100);
        };
        reader.readAsDataURL(file);
      }
    }

    function handleImageClick(e){
      const img = e.target;
      const rect = img.getBoundingClientRect();
      const scaleX = img.naturalWidth / rect.width;
      const scaleY = img.naturalHeight / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      const positions = state.fieldPositions[state.currentTemplate][state.currentLang];
      let fieldKey;

      if(state.repositionTarget){ fieldKey = state.repositionTarget; state.repositionTarget=null; }
      else if(state.selectedField){
        fieldKey = state.selectedField;
        if(state.multiInstanceMode && positions[fieldKey]){
          let i=2; while(positions[`${state.selectedField}_${i}`]) i++;
          fieldKey = `${state.selectedField}_${i}`;
        }
      } else { return; }

      positions[fieldKey] = {
        x:Math.round(x), y:Math.round(y),
        fontSize: positions[fieldKey]?.fontSize || 44,
        color: positions[fieldKey]?.color || '#000000',
        baseField: positions[fieldKey]?.baseField || state.selectedField || fieldKey.replace(/_\\d+$/, ''),
        width: (positions[fieldKey]?.baseField==='signature' || state.selectedField==='signature') ? (positions[fieldKey]?.width || 150) : undefined,
        height:(positions[fieldKey]?.baseField==='signature' || state.selectedField==='signature') ? (positions[fieldKey]?.height|| 50) : undefined
      };
      saveToLocalStorage(); render(); setTimeout(renderFieldMarkers, 50);
    }

    function repositionField(key){ state.repositionTarget=key; state.selectedField=null; render(); }
    function editField(name){ state.editingField=name; render(); }
    function deleteField(name){
      if(confirm('ç¡®å®šåˆ é™¤è¯¥å­—æ®µé…ç½®å—?')){
        delete state.fieldPositions[state.currentTemplate][state.currentLang][name];
        saveToLocalStorage(); render(); setTimeout(renderFieldMarkers, 50);
      }
    }
    function saveFieldParams(){
      const fz = document.getElementById('editFontSize').value;
      const color = document.getElementById('editColor').value;
      const w = document.getElementById('editWidth')?.value;
      const h = document.getElementById('editHeight')?.value;
      const pos = state.fieldPositions[state.currentTemplate][state.currentLang][state.editingField];
      pos.fontSize = parseInt(fz); pos.color = color;
      if(w) pos.width = parseInt(w); if(h) pos.height = parseInt(h);
      state.editingField=null; saveToLocalStorage(); render(); setTimeout(renderFieldMarkers, 50);
    }

    function downloadConfig(){
      const conf = { templates: state.templates, fieldPositions: state.fieldPositions };
      const blob = new Blob([JSON.stringify(conf,null,2)], {type:'application/json'});
      safeDownloadFromBlob(blob, 'form-config.json');
    }
    function loadConfig(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev)=>{
        try{
          const conf = JSON.parse(ev.target.result);
          state.templates = conf.templates || { contract:{ zh:null, ko:null }, safety:{ zh:null, ko:null } };
          state.fieldPositions = conf.fieldPositions || { contract:{ zh:{}, ko:{} }, safety:{ zh:{}, ko:{} } };
          saveToLocalStorage(); render(); setTimeout(renderFieldMarkers, 100);
          alert('âœ… é…ç½®å¯¼å…¥æˆåŠŸ!');
        }catch{ alert('âŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯'); }
      };
      reader.readAsText(file);
    }
    function clearAllData(){
      if(confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é…ç½®å—?æ­¤æ“ä½œä¸å¯æ¢å¤!')){
        localStorage.removeItem('formFillerConfig');
        state.templates = { contract:{ zh:null, ko:null }, safety:{ zh:null, ko:null } };
        state.fieldPositions = { contract:{ zh:{}, ko:{} }, safety:{ zh:{}, ko:{} } };
        render(); alert('âœ… æ‰€æœ‰é…ç½®å·²æ¸…ç©º');
      }
    }

    // ===================== æ¨¡å¼åˆ‡æ¢ & å¯†ç é¡µ =====================
    function toggleMode(){
      if(!state.isAdminMode){ state.showPasswordPage=true; render(); }
      else { state.isAdminMode=false; render(); }
    }
    function checkPassword(){
      const pwd = document.getElementById('passwordInput').value;
      const error = document.getElementById('errorMsg');
      if(pwd==='admin123'){ state.showPasswordPage=false; state.isAdminMode=true; render(); }
      else { error.classList.add('show'); setTimeout(()=>error.classList.remove('show'), 2000); }
    }
    function cancelPassword(){ state.showPasswordPage=false; render(); }
    function handlePasswordKeyPress(e){ if(e.key==='Enter') checkPassword(); }

    // ===================== æ¸²æŸ“è¾…åŠ© =====================
    function getExampleText(fieldKey, lang){
      const base = fieldKey.replace(/_\\d+$/, '');
      const examples = {
        name:{ zh:'å¼ ä¸‰', ko:'ê¹€ì² ìˆ˜', vi:'Nguyá»…n VÄƒn A', ru:'Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²' },
        birthday:{ zh:'1990-01-01', ko:'1990-01-01', vi:'1990-01-01', ru:'1990-01-01' },
        address:{ zh:'åŒ—äº¬å¸‚æœé˜³åŒº', ko:'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬', vi:'HÃ  Ná»™i', ru:'ĞœĞ¾ÑĞºĞ²Ğ°' },
        position:{ zh:'æ•´ç†', ko:'ì •ë¦¬', vi:'ì •ë¦¬', ru:'ì •ë¦¬' },
        passport:{ zh:'E12345678', ko:'M12345678', vi:'B1234567', ru:'AB1234567' },
        phone:{ zh:'138-0013-8000', ko:'010-1234-5678', vi:'091-2345-678', ru:'+7 900 123-45-67' },
        residentNum:{ zh:'110101-1990011234', ko:'900101-1234567', vi:'001090-0001234', ru:'123456-7890123' },
        experience:{ zh:'3å¹´', ko:'3ë…„', vi:'3 nÄƒm', ru:'3 Ğ»ĞµÑ‚' },
        month:{ zh:getCurrentMonth(), ko:getCurrentMonth(), vi:getCurrentMonth(), ru:getCurrentMonth() },
        day:{ zh:getCurrentDay(), ko:getCurrentDay(), vi:getCurrentDay(), ru:getCurrentDay() },
        checkmark:{ zh:'âœ“', ko:'âœ“', vi:'âœ“', ru:'âœ“' },
        signature:{ zh:'å¼ ä¸‰', ko:'ê¹€ì² ìˆ˜', vi:'Nguyá»…n VÄƒn A', ru:'Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²' }
      };
      const langKey = (lang==='ko'||lang==='vi'||lang==='ru')?lang:'zh';
      return examples[base]?.[langKey] || 'ç¤ºä¾‹';
    }

    function renderFieldMarkers(){
      const img = document.getElementById('templateImage');
      const container = document.getElementById('markersContainer');
      if(!img || !container) return;
      const positions = state.fieldPositions[state.currentTemplate][state.currentLang] || {};
      container.innerHTML='';

      const displayWidth = img.clientWidth, displayHeight = img.clientHeight;
      const naturalWidth = img.naturalWidth, naturalHeight = img.naturalHeight;
      const scaleX = displayWidth / naturalWidth, scaleY = displayHeight / naturalHeight;

      let idx=1;
      Object.keys(positions).forEach(key=>{
        const pos = positions[key]; if(!pos || pos.x==null || pos.y==null) return;
        const dx = pos.x * scaleX, dy = pos.y * scaleY;
        const baseField = pos.baseField || key;

        const marker = document.createElement('div'); marker.className='field-marker'; marker.textContent=idx;
        marker.style.left = dx+'px'; marker.style.top = dy+'px';
        const label = document.createElement('div'); label.className='field-label'; label.textContent=key; label.style.left=dx+'px'; label.style.top=dy+'px';
        container.appendChild(marker); container.appendChild(label);

        if(baseField!=='signature'){
          const previewText = document.createElement('div');
          previewText.className='field-preview-text';
          previewText.textContent = getExampleText(key, state.currentLang);
          previewText.style.left = dx+'px'; previewText.style.top = dy+'px';
          previewText.style.fontSize = ((pos.fontSize||44) * scaleX) + 'px';
          previewText.style.color = pos.color || '#000';
          previewText.style.fontFamily = 'Arial';
          container.appendChild(previewText);
        }else{
          const sigBox = document.createElement('div');
          sigBox.style.position='absolute'; sigBox.style.left=dx+'px'; sigBox.style.top=dy+'px';
          sigBox.style.width=((pos.width||150)*scaleX)+'px'; sigBox.style.height=((pos.height||50)*scaleY)+'px';
          sigBox.style.border='2px dashed rgba(74,144,164,.6)'; sigBox.style.backgroundColor='rgba(74,144,164,.1)'; sigBox.style.zIndex='8';
          container.appendChild(sigBox);
        }
        idx++;
      });
    }

    function getFieldDisplayName(key){
      const m = key.match(/^(.+)_([0-9]+)$/); if(m) return `${m[1]} (${m[2]})`; return key;
    }

    // ===================== UIæ¸²æŸ“ =====================
    function renderPasswordPage(){
      return `
        <div class="container password-container">
          <h2 class="password-title">ç®¡ç†å‘˜éªŒè¯</h2>
          <p class="password-subtitle">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥ç»§ç»­</p>
          <input type="password" id="passwordInput" class="password-input" placeholder="è¯·è¾“å…¥å¯†ç " onkeypress="handlePasswordKeyPress(event)" autofocus>
          <button onclick="checkPassword()" class="password-btn">ç¡®è®¤ç™»å½•</button>
          <p id="errorMsg" class="password-error">âŒ å¯†ç é”™è¯¯,è¯·é‡è¯•</p>
          <button onclick="cancelPassword()" class="clear-btn">è¿”å›</button>
        </div>
      `;
    }

    function renderAdminMode(){
      const t = translations[state.language];
      const positions = state.fieldPositions[state.currentTemplate][state.currentLang] || {};
      const fieldsList = getFieldsList(state.currentLang);
      return `
        <div class="container admin-container">
          <div class="admin-header">
            <h1 class="admin-title">ç®¡ç†å‘˜é…ç½®æ¨¡å¼</h1>
            <button onclick="toggleMode()" class="toggle-btn">${t.userMode}</button>
          </div>

          <div class="admin-layout">
            <div class="left-panel">
              <h3 class="section-title">ğŸ“‹ æ¨¡æ¿é…ç½®</h3>
              <div class="template-tabs">
                <button onclick="state.currentTemplate='contract'; render(); setTimeout(renderFieldMarkers,100);" class="tab-btn ${state.currentTemplate==='contract'?'active':''}">åŠ³åŠ¨åˆåŒ</button>
                <button onclick="state.currentTemplate='safety'; render(); setTimeout(renderFieldMarkers,100);" class="tab-btn ${state.currentTemplate==='safety'?'active':''}">å®‰å…¨åè®®</button>
              </div>
              <div class="language-tabs">
                <button onclick="state.currentLang='zh'; render(); setTimeout(renderFieldMarkers,100);" class="lang-btn ${state.currentLang==='zh'?'active':''}">ä¸­æ–‡/è¶Šå—è¯­/ä¿„è¯­</button>
                <button onclick="state.currentLang='ko'; render(); setTimeout(renderFieldMarkers,100);" class="lang-btn ${state.currentLang==='ko'?'active':''}">í•œêµ­ì–´</button>
              </div>

              <div class="upload-section">
                <label>ğŸ“¤ ä¸Šä¼  ${state.currentTemplate==='contract'?'åŠ³åŠ¨åˆåŒ':'å®‰å…¨åè®®'} æ¨¡æ¿ (${state.currentLang==='zh'?'ä¸­æ–‡/è¶Šå—è¯­/ä¿„è¯­':'í•œêµ­ì–´'})</label>
                <input type="file" accept="image/*" onchange="handleTemplateUpload(event,'${state.currentTemplate}','${state.currentLang}')" style="margin-top:10px;">
              </div>

              <div class="form-group">
                <label>ğŸ¯ é€‰æ‹©å­—æ®µ (ç‚¹å‡»åå†ç‚¹å‡»å›¾ç‰‡å®šä½)</label>
                <div class="field-buttons">
                  ${fieldsList.map(f=>`<button onclick="state.selectedField='${f}'; render();" class="field-btn ${state.selectedField===f?'active':''}">${f==='checkmark'?'âœ“':f}</button>`).join('')}
                </div>
                <div class="mode-switch">
                  <input type="checkbox" id="multiInstanceMode" ${state.multiInstanceMode?'checked':''} onchange="state.multiInstanceMode=this.checked; render();">
                  <label for="multiInstanceMode">ğŸ”„ å¤šå®ä¾‹æ¨¡å¼(åŒä¸€å­—æ®µåˆ›å»ºå¤šä¸ªä½ç½®)</label>
                </div>
                <p class="note">${state.multiInstanceMode?'âœ… å¤šå®ä¾‹æ¨¡å¼: ç‚¹å‡»å›¾ç‰‡ä¼šåˆ›å»º name_2 / name_3...':'ğŸ” æ™®é€šæ¨¡å¼: ç‚¹å‡»å›¾ç‰‡æ›´æ–°æ‰€é€‰å­—æ®µåæ ‡'}</p>
                <p class="note" style="color:#4A90A4;">ğŸ’¡ æœˆä»½/æ—¥æœŸ/å¯¹å·ä¼šè‡ªåŠ¨å¡«å……å½“å‰å€¼</p>
              </div>

              ${state.templates[state.currentTemplate][state.currentLang] ? `
                <div class="preview-box">
                  <p style="margin-bottom:10px; font-weight:600; color:#2E4F7A;">
                    ${state.repositionTarget ? `ğŸ¯ ç‚¹å‡»å›¾ç‰‡é‡æ–°å®šä½: ${getFieldDisplayName(state.repositionTarget)}` : (state.selectedField ? `âœ… å·²é€‰æ‹©: ${state.selectedField}` : 'âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå­—æ®µ')}
                  </p>
                  <div class="image-wrapper">
                    <img id="templateImage" src="${state.templates[state.currentTemplate][state.currentLang]}" alt="template" onclick="handleImageClick(event)" onload="renderFieldMarkers()">
                    <div id="markersContainer"></div>
                  </div>
                </div>
              ` : '<p class="note" style="text-align:center; padding:40px;">è¯·å…ˆä¸Šä¼ æ¨¡æ¿å›¾ç‰‡</p>'}

              <div class="field-buttons" style="gap:15px; margin-top:10px;">
                <button onclick="downloadConfig()" class="action-btn" style="background:#4A90A4; color:#fff;">ğŸ“¥ å¯¼å‡ºé…ç½®</button>
                <label class="action-btn" style="background:#3E5F8A; color:#fff;">ğŸ“¤ å¯¼å…¥é…ç½®
                  <input type="file" accept=".json" onchange="loadConfig(event)" style="display:none">
                </label>
                <button onclick="clearAllData()" class="action-btn" style="background:#C73E1D; color:#fff;">ğŸ—‘ï¸ æ¸…ç©ºé…ç½®</button>
              </div>
              <p class="note">ğŸ’¾ é…ç½®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°</p>
            </div>

            <div class="right-panel">
              <h3 class="section-title">âš™ï¸ å·²é…ç½®å­—æ®µ</h3>
              ${Object.keys(positions).length===0 ? '<p class="note" style="text-align:center; padding:20px;">æš‚æ— é…ç½®</p>' :
                `<div class="field-list">
                  ${Object.keys(positions).map(k=>{
                    const pos = positions[k]; const base = pos.baseField || k;
                    return `
                      <div class="field-item">
                        <div class="field-item-header">
                          <span class="field-name">ğŸ“Œ ${getFieldDisplayName(k)}</span>
                          <div class="field-actions">
                            <button onclick="repositionField('${k}')" class="reposition-btn">é‡æ–°å®šä½</button>
                            <button onclick="editField('${k}')" class="edit-btn">ç¼–è¾‘</button>
                            <button onclick="deleteField('${k}')" class="delete-btn">åˆ é™¤</button>
                          </div>
                        </div>
                        ${state.editingField===k ? `
                          <div class="param-editor">
                            <div class="param-row"><span class="param-label">å­—ä½“å¤§å°:</span><input type="number" id="editFontSize" value="${pos.fontSize||44}" min="8" max="120"></div>
                            <div class="param-row"><span class="param-label">é¢œè‰²:</span><input type="color" id="editColor" value="${pos.color||'#000000'}" style="height:40px;"></div>
                            ${base==='signature' ? `
                              <div class="param-row"><span class="param-label">å®½åº¦:</span><input type="number" id="editWidth" value="${pos.width||150}" min="50" max="500"></div>
                              <div class="param-row"><span class="param-label">é«˜åº¦:</span><input type="number" id="editHeight" value="${pos.height||50}" min="20" max="200"></div>` : ''}
                            <button onclick="saveFieldParams()" class="save-param-btn">âœ… ä¿å­˜å‚æ•°</button>
                          </div>` :
                          `<div class="field-params" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:12px; color:#5A7A8F;">
                            <div>X: ${pos.x}</div><div>Y: ${pos.y}</div>
                            <div>å­—å·: ${pos.fontSize||44}px</div>
                            <div>é¢œè‰²: <span style="display:inline-block; width:20px; height:20px; background:${pos.color||'#000'}; border:1px solid #ccc; vertical-align:middle;"></span></div>
                            ${pos.width?`<div>å®½: ${pos.width}px</div>`:''}
                            ${pos.height?`<div>é«˜: ${pos.height}px</div>`:''}
                          </div>`}
                      </div>`;
                  }).join('')}
                </div>`}
            </div>
          </div>
        </div>
      `;
    }

    function renderUserMode(){
      const t = translations[state.language];
      const fields = getFieldsList(state.language).filter(f=>!['signature','month','day','checkmark'].includes(f));
      return `
        <div class="container">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h1>${t.title}</h1>
            <button onclick="toggleMode()" class="toggle-btn">${t.adminMode}</button>
          </div>

          <div class="form-group">
            <label>${t.selectLanguage}</label>
            <div class="language-buttons">
              ${[{code:'zh',label:'ä¸­æ–‡'},{code:'ko',label:'í•œêµ­ì–´'},{code:'vi',label:'Tiáº¿ng Viá»‡t'},{code:'ru',label:'Ğ ÑƒÑÑĞºĞ¸Ğ¹'}].map(l=>`
                <button onclick=\"state.language='${l.code}'; render();\" class=\"lang-btn ${state.language===l.code?'active':''}\">${l.label}</button>`).join('')}
            </div>
          </div>

          ${fields.map(field=>{
            if(field==='position'){
              return `
                <div class="form-group">
                  <label>${t.position}</label>
                  <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button onclick="state.positionMode='custom'; render();" class="lang-btn ${state.positionMode==='custom'?'active':''}" style="flex:1;">${t.positionCustom}</button>
                    <button onclick="state.positionMode='select'; render();" class="lang-btn ${state.positionMode==='select'?'active':''}" style="flex:1;">${t.positionSelect}</button>
                  </div>
                  ${state.positionMode==='custom'
                    ? `<input type="text" value="${state.formData[field]||''}" oninput="state.formData['${field}']=this.value">`
                    : `<select onchange="state.formData['${field}']=this.value"><option value="">-- ${t.positionSelect} --</option>${
                        positionOptions[state.language].map(opt=>`<option value=\"${opt}\" ${state.formData[field]===opt?'selected':''}>${opt}</option>`).join('')
                      }</select>`}
                </div>`;
            }else if(field==='phone'){
              return `
                <div class="form-group">
                  <label>${t.phone}</label>
                  <input type="text" value="${state.formData[field]||''}" oninput="
                    (function(v){ const n=v.replace(/\\D/g,''); let out=n.length<=3?n:n.length<=7? n.slice(0,3)+'-'+n.slice(3) : n.slice(0,3)+'-'+n.slice(3,7)+'-'+n.slice(7,11); state.formData['${field}']=out; })(this.value);
                    this.value = state.formData['${field}'];
                  ">
                </div>`;
            }else if(field==='residentNum'){
              return `
                <div class="form-group">
                  <label>å±…æ°‘/èº«ä»½è¯å·</label>
                  <input type="text" value="${state.formData[field]||''}" oninput="
                    (function(v){ const n=v.replace(/\\D/g,''); const out = n.length<=6 ? n : n.slice(0,6)+'-'+n.slice(6,13); state.formData['${field}']=out; })(this.value);
                    this.value = state.formData['${field}'];
                  ">
                </div>`;
            }else if(field==='experience'){
              return `
                <div class="form-group">
                  <label>${t.experience}</label>
                  <div style="position:relative;">
                    <input type="text" value="${state.formData[field]||''}" oninput="(function(v){ const n=v.replace(/\\D/g,''); state.formData['${field}']=n; })(this.value); this.value = state.formData['${field}'];" style="padding-right:50px;">
                    <span style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:#5A7A8F; font-size:14px; pointer-events:none;">${t.experienceYears}</span>
                  </div>
                </div>`;
            }else if(field==='address'){
              return `
                <div class="form-group">
                  <label>${t.address}</label>
                  <div style="display:flex; gap:10px;">
                    <input type="text" value="${state.formData[field]||''}" oninput="state.formData['${field}']=this.value" style="flex:1;">
                    <button type="button" onclick="openAddressSearch()" class="lang-btn" style="background:#3E5F8A; color:#fff;">ğŸ—ºï¸ ${t.addressSearch}</button>
                  </div>
                  <p class="note">${t.addressHint}</p>
                </div>`;
            }else{
              return `
                <div class="form-group">
                  <label>${t[field] || field}</label>
                  <input type="${field==='birthday' ? 'date' : 'text'}" value="${state.formData[field]||''}" oninput="state.formData['${field}']=this.value">
                </div>`;
            }
          }).join('')}

          <div class="form-group">
            <label>${t.signature}</label>
            <div class="signature-container">
              <canvas id="signatureCanvas" width="600" height="180"></canvas>
            </div>
            <button onclick="clearSignature(); render();" class="clear-btn">${t.clearSignature}</button>
          </div>

          <button class="generate-btn" onclick="generateForms()">ğŸ–¼ï¸ ${t.generate}</button>
          <p class="note">${t.generateNote}</p>
        </div>
      `;
    }

    function openAddressSearch(){
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:999999; display:flex; align-items:center; justify-content:center; padding:20px;';

      const content = document.createElement('div');
      content.style.cssText = 'background:#fff; border-radius:12px; width:95%; max-width:1100px; height:90vh; max-height:850px; display:flex; flex-direction:column; overflow:hidden;';
      content.innerHTML = `
        <div style="padding:16px 20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
          <strong>ğŸ—ºï¸ Naver åœ°å›¾ - åœ°å€æœç´¢</strong>
          <button class="lang-btn" style="background:#C73E1D; color:#fff;" onclick="document.getElementById('mapModal').remove(); document.body.style.overflow='';">âœ• å…³é—­</button>
        </div>
        <div style="flex:1; padding:16px; display:flex; flex-direction:column; gap:12px; background:#f9fafb;">
          <div style="background:#F0F8F9; border:2px solid #A8DADC; padding:12px; border-radius:8px; color:#2E4F7A;">
            1) åœ¨ä¸‹æ–¹ Naver åœ°å›¾ä¸­æœç´¢ä½ çš„åœ°å€ â†’ 2) å¤åˆ¶å®Œæ•´åœ°å€ â†’ 3) è¿”å›è¡¨å•ç²˜è´´
          </div>
          <iframe src="https://map.naver.com/" style="width:100%; flex:1; border:2px solid #e5e7eb; border-radius:8px; background:#fff;"></iframe>
        </div>`;

      const wrapper = document.createElement('div');
      wrapper.id = 'mapModal'; wrapper.appendChild(content);
      overlay.appendChild(content);
      wrapper.appendChild(overlay);
      document.body.appendChild(wrapper);
      document.body.style.overflow = 'hidden';
      overlay.addEventListener('click', (e)=>{ if(e.target===overlay){ wrapper.remove(); document.body.style.overflow=''; } });
    }

    // ===================== ä¸»æ¸²æŸ“å…¥å£ =====================
    function render(){
      const app = document.getElementById('app');
      if(state.showPasswordPage){ app.innerHTML = renderPasswordPage(); return; }
      app.innerHTML = state.isAdminMode ? renderAdminMode() : renderUserMode();

      // ç»‘å®šç­¾åæ¿
      const canvas = document.getElementById('signatureCanvas');
      if(canvas){
        signatureCanvas = canvas; sigCtx = canvas.getContext('2d'); sigCtx.lineWidth = 2; sigCtx.lineCap='round';
        canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, {passive:true}); canvas.addEventListener('touchmove', draw, {passive:false}); window.addEventListener('touchend', stopDrawing);
      }
    }

    // åˆå§‹åŒ–
    initConfig();
  </script>
</body>
</html>
